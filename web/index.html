<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K8s LLM Monitor 控制台</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg-gradient: radial-gradient(circle at 20% 20%, #0ea5e9 0%, rgba(14, 165, 233, 0) 55%),
                radial-gradient(circle at 80% 0%, #6366f1 0%, rgba(99, 102, 241, 0) 45%),
                #0f172a;
            --card-bg: rgba(15, 23, 42, 0.72);
            --card-border: rgba(148, 163, 184, 0.25);
            --text-strong: #f8fafc;
            --text-muted: #cbd5f5;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.2);
            --success: #34d399;
            --warn: #f97316;
            --error: #f43f5e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-gradient);
            color: var(--text-strong);
            display: flex;
            justify-content: center;
            padding: 40px 16px 80px;
        }

        .app {
            width: min(1180px, 100%);
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .hero {
            background: linear-gradient(130deg, rgba(99, 102, 241, 0.85), rgba(14, 165, 233, 0.65));
            border-radius: 26px;
            padding: 32px clamp(24px, 5vw, 48px);
            box-shadow: 0 40px 90px rgba(15, 23, 42, 0.45);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 18px;
        }

        .hero h1 {
            font-size: clamp(28px, 4vw, 38px);
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .hero p {
            margin-top: 10px;
            font-size: 15px;
            color: rgba(241, 245, 249, 0.85);
            max-width: 520px;
            line-height: 1.6;
        }

        .hero-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .hero-actions button {
            border: none;
            background: rgba(15, 23, 42, 0.8);
            color: #38bdf8;
            padding: 11px 24px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.04em;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hero-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.45);
        }

        .hero-actions button:disabled {
            opacity: 0.55;
            cursor: progress;
        }

        .hero-actions .timestamp {
            font-size: 13px;
            font-weight: 500;
            color: rgba(241, 245, 249, 0.7);
        }

        .status-bar {
            border-radius: 18px;
            padding: 14px 18px;
            background: rgba(30, 41, 59, 0.75);
            border: 1px solid rgba(148, 163, 184, 0.2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-bar[data-variant="success"] {
            border-color: rgba(52, 211, 153, 0.35);
            color: #bbf7d0;
        }

        .status-bar[data-variant="error"] {
            border-color: rgba(244, 63, 94, 0.4);
            color: #fecaca;
        }

        .summary-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .summary-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 22px;
            padding: 22px 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::after {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at top right, rgba(148, 163, 184, 0.35), transparent 55%);
            opacity: 0.4;
        }

        .summary-card strong {
            font-size: 13px;
            letter-spacing: 0.12em;
            color: rgba(226, 232, 240, 0.7);
        }

        .summary-card span.value {
            font-size: clamp(26px, 4vw, 32px);
            font-weight: 700;
            color: var(--accent);
        }

        .summary-card span.note {
            font-size: 13px;
            color: rgba(226, 232, 240, 0.6);
        }

        .sub {
            font-size: 13px;
            color: rgba(203, 213, 225, 0.7);
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 16px;
        }

        .section-header h2 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .section-header .tag {
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 20px 24px;
            box-shadow: 0 30px 70px rgba(15, 23, 42, 0.35);
        }

        .table-wrap {
            width: 100%;
            overflow-x: auto;
        }

        .table-wrap::-webkit-scrollbar {
            height: 6px;
        }

        .table-wrap::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 999px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            font-size: 12px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(226, 232, 240, 0.55);
            padding-bottom: 12px;
        }

        tbody td {
            padding: 14px 0;
            border-top: 1px solid rgba(148, 163, 184, 0.18);
            font-size: 14px;
            color: rgba(226, 232, 240, 0.86);
        }

        tbody tr:first-child td {
            border-top: none;
        }

        .status-dot {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot::before {
            content: "";
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 0 6px rgba(52, 211, 153, 0.12);
        }

        .status-dot[data-status="warning"]::before {
            background: var(--warn);
            box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.16);
        }

        .status-dot[data-status="error"]::before {
            background: var(--error);
            box-shadow: 0 0 0 6px rgba(244, 63, 94, 0.18);
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .metric span.primary {
            font-weight: 600;
            color: var(--accent);
        }

        .metric span.sub {
            font-size: 12px;
            color: rgba(203, 213, 225, 0.65);
        }

        .uav-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        .uav-card {
            background: linear-gradient(140deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.78));
            border-radius: 22px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(16px);
        }

        .uav-card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.35), transparent 60%);
            opacity: 0.35;
            pointer-events: none;
        }

        .uav-card > * {
            position: relative;
            z-index: 1;
        }

        .uav-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .uav-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(226, 232, 240, 0.16);
            color: rgba(241, 245, 249, 0.9);
        }

        .badge[data-variant="success"] {
            background: rgba(52, 211, 153, 0.18);
            color: #bbf7d0;
        }

        .badge[data-variant="warning"] {
            background: rgba(249, 115, 22, 0.18);
            color: #fed7aa;
        }

        .details {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        .details span {
            font-size: 13px;
            color: rgba(226, 232, 240, 0.75);
        }

        .details strong {
            display: block;
            font-size: 12px;
            color: rgba(148, 163, 184, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 4px;
        }

        .empty-state {
            text-align: center;
            font-size: 14px;
            color: rgba(203, 213, 225, 0.65);
            padding: 24px 0;
        }

        @media (max-width: 720px) {
            body {
                padding-top: 32px;
            }

            .hero-actions {
                width: 100%;
                align-items: stretch;
            }

            .hero-actions button {
                width: 100%;
                justify-content: center;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <main class="app">
        <header class="hero">
            <div>
                <h1>K8s LLM Monitor · 实时控制台</h1>
                <p>纵览集群资源、Pod 运行状态与 UAV 遥测数据。所有指标均来自实时 API 与 Kubernetes 自定义资源 (CRD)。</p>
            </div>
            <div class="hero-actions">
                <button id="refreshButton">手动刷新</button>
                <span class="timestamp" id="lastUpdated">最后更新：-</span>
            </div>
        </header>

        <section class="status-bar" id="statusBar" data-variant="success" hidden>
            <span id="statusText">状态</span>
        </section>

        <section class="summary-grid">
            <article class="summary-card" id="summaryNodes">
                <strong>节点</strong>
                <span class="value">-</span>
                <span class="note">健康节点 / 总节点</span>
            </article>
            <article class="summary-card" id="summaryPods">
                <strong>工作负载</strong>
                <span class="value">-</span>
                <span class="note">运行中 Pod / 总 Pod</span>
            </article>
            <article class="summary-card" id="summaryCpu">
                <strong>CPU 利用率</strong>
                <span class="value">-</span>
                <span class="note">已用 / 总量</span>
            </article>
            <article class="summary-card" id="summaryUav">
                <strong>UAV 心跳</strong>
                <span class="value">-</span>
                <span class="note">活跃 UAV / CRD 记录</span>
            </article>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>节点指标</h2>
                <span class="tag" id="nodeCount">- 节点</span>
            </div>
            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>节点</th>
                                <th>CPU</th>
                                <th>内存</th>
                                <th>磁盘</th>
                                <th>健康</th>
                            </tr>
                        </thead>
                        <tbody id="nodesTableBody">
                            <tr><td colspan="5" class="empty-state">加载中…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>Pod 资源热点</h2>
                <span class="tag" id="podCount">- Pods</span>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>所在节点</th>
                            <th>CPU 使用</th>
                            <th>内存使用</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="podsTableBody">
                        <tr><td colspan="5" class="empty-state">加载中…</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>UAV 遥测与 CRD 概览</h2>
                <span class="tag" id="uavCount">- UAV</span>
            </div>
            <div class="uav-grid" id="uavGrid">
                <div class="empty-state">加载中…</div>
            </div>
        </section>
    </main>

    <script>
        const REFRESH_INTERVAL = 15000;
        const endpoints = {
            cluster: '/api/v1/metrics/cluster',
            nodes: '/api/v1/metrics/nodes',
            pods: '/api/v1/metrics/pods',
            uavMetrics: '/api/v1/metrics/uav',
            uavCrd: '/api/v1/crd/uav'
        };

        const elements = {
            refreshButton: document.getElementById('refreshButton'),
            lastUpdated: document.getElementById('lastUpdated'),
            statusBar: document.getElementById('statusBar'),
            statusText: document.getElementById('statusText'),
            summaryNodes: document.querySelector('#summaryNodes .value'),
            summaryNodesNote: document.querySelector('#summaryNodes .note'),
            summaryPods: document.querySelector('#summaryPods .value'),
            summaryPodsNote: document.querySelector('#summaryPods .note'),
            summaryCpu: document.querySelector('#summaryCpu .value'),
            summaryCpuNote: document.querySelector('#summaryCpu .note'),
            summaryUav: document.querySelector('#summaryUav .value'),
            summaryUavNote: document.querySelector('#summaryUav .note'),
            nodesTableBody: document.getElementById('nodesTableBody'),
            podsTableBody: document.getElementById('podsTableBody'),
            uavGrid: document.getElementById('uavGrid'),
            nodeCount: document.getElementById('nodeCount'),
            podCount: document.getElementById('podCount'),
            uavCount: document.getElementById('uavCount')
        };

        function showStatus(message, variant = 'success') {
            elements.statusText.textContent = message;
            elements.statusBar.dataset.variant = variant;
            elements.statusBar.hidden = false;
        }

        function hideStatus() {
            elements.statusBar.hidden = true;
        }

        function setLoading(isLoading) {
            elements.refreshButton.disabled = isLoading;
            if (isLoading) {
                elements.refreshButton.textContent = '刷新中…';
            } else {
                elements.refreshButton.textContent = '手动刷新';
            }
        }

        async function fetchJSON(url) {
            const response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`请求 ${url} 失败：${response.status} ${text}`);
            }
            return response.json();
        }

        function formatMillicores(m) {
            if (typeof m !== 'number' || Number.isNaN(m)) return '-';
            return `${(m / 1000).toFixed(2)} 核`;
        }

        function formatBytes(bytes) {
            if (typeof bytes !== 'number' || Number.isNaN(bytes)) return '-';
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            const index = Math.floor(Math.log(bytes) / Math.log(1024));
            const value = bytes / Math.pow(1024, index);
            return `${value.toFixed(index === 0 ? 0 : 1)} ${units[index]}`;
        }

        function formatPercent(value) {
            if (typeof value !== 'number' || Number.isNaN(value)) return '-';
            return `${value.toFixed(1)}%`;
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp;
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString('zh-CN', { hour12: false });
        }

        function updateSummary(cluster, uavMetrics, crdCount) {
            if (cluster) {
                const totalNodes = cluster.total_nodes ?? 0;
                const healthyNodes = cluster.healthy_nodes ?? 0;
                const totalPods = cluster.total_pods ?? 0;
                const runningPods = cluster.running_pods ?? 0;
                const totalCpu = cluster.total_cpu ?? 0;
                const usedCpu = cluster.used_cpu ?? 0;

                elements.summaryNodes.textContent = `${healthyNodes}/${totalNodes}`;
                elements.summaryNodesNote.textContent = '健康节点 / 总节点';

                elements.summaryPods.textContent = `${runningPods}/${totalPods}`;
                elements.summaryPodsNote.textContent = '运行中 Pod / 总 Pod';

                elements.summaryCpu.textContent = formatPercent(cluster.cpu_usage_rate ?? 0);
                elements.summaryCpuNote.textContent = `${formatMillicores(usedCpu)} / ${formatMillicores(totalCpu)}`;

                elements.nodeCount.textContent = `${totalNodes} 节点`;
                elements.podCount.textContent = `${totalPods} Pods`;
            } else {
                elements.summaryNodes.textContent = '-';
                elements.summaryPods.textContent = '-';
                elements.summaryCpu.textContent = '-';
            }

            const uavEntries = Object.keys(uavMetrics ?? {});
            elements.summaryUav.textContent = `${uavEntries.length}/${crdCount}`;
            elements.summaryUavNote.textContent = '活跃 UAV / CRD 记录';
            elements.uavCount.textContent = `${crdCount} UAV 记录`;
        }

        function updateNodesTable(nodesMap) {
            const nodes = Object.values(nodesMap ?? {});
            if (!nodes.length) {
                elements.nodesTableBody.innerHTML = '<tr><td colspan="5" class="empty-state">暂无节点数据</td></tr>';
                return;
            }

            nodes.sort((a, b) => (b.cpu_usage_rate ?? 0) - (a.cpu_usage_rate ?? 0));

            const rows = nodes.map(node => {
                const status = node.healthy ? 'healthy' : 'warning';
                const statusLabel = node.healthy ? 'Healthy' : 'Attention';
                return `
                    <tr>
                        <td>
                            <div class="metric">
                                <span class="primary">${node.node_name ?? '-'}</span>
                                <span class="sub">CPU ${formatMillicores(node.cpu_capacity ?? 0)} · 内存 ${formatBytes(node.memory_capacity ?? 0)}</span>
                            </div>
                        </td>
                        <td>
                            <div class="metric">
                                <span class="primary">${formatPercent(node.cpu_usage_rate)}</span>
                                <span class="sub">${formatMillicores(node.cpu_usage)} / ${formatMillicores(node.cpu_capacity)}</span>
                            </div>
                        </td>
                        <td>
                            <div class="metric">
                                <span class="primary">${formatPercent(node.memory_usage_rate)}</span>
                                <span class="sub">${formatBytes(node.memory_usage)} / ${formatBytes(node.memory_capacity)}</span>
                            </div>
                        </td>
                        <td>
                            <div class="metric">
                                <span class="primary">${formatPercent(node.disk_usage_rate)}</span>
                                <span class="sub">${formatBytes(node.disk_usage)} / ${formatBytes(node.disk_capacity)}</span>
                            </div>
                        </td>
                        <td><span class="status-dot" data-status="${status}">${statusLabel}</span></td>
                    </tr>
                `;
            });

            elements.nodesTableBody.innerHTML = rows.join('');
        }

        function updatePodsTable(podsMap) {
            const pods = Object.values(podsMap ?? {});
            if (!pods.length) {
                elements.podsTableBody.innerHTML = '<tr><td colspan="5" class="empty-state">暂无 Pod 指标数据</td></tr>';
                return;
            }

            pods.sort((a, b) => (b.cpu_usage ?? 0) - (a.cpu_usage ?? 0));
            const topPods = pods.slice(0, 8);

            const rows = topPods.map(pod => {
                const name = `${pod.namespace ?? '-'} / ${pod.pod_name ?? '-'}`;
                const cpu = `${formatMillicores(pod.cpu_usage)}${pod.cpu_limit ? ` / ${formatMillicores(pod.cpu_limit)}` : ''}`;
                const mem = `${formatBytes(pod.memory_usage)}${pod.memory_limit ? ` / ${formatBytes(pod.memory_limit)}` : ''}`;
                const status = pod.phase ?? '-';
                return `
                    <tr>
                        <td>
                            <div class="metric">
                                <span class="primary">${name}</span>
                                <span class="sub">重启 ${pod.restarts ?? 0} 次</span>
                            </div>
                        </td>
                        <td>${pod.node_name ?? '-'}</td>
                        <td>${cpu}</td>
                        <td>${mem}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });

            elements.podsTableBody.innerHTML = rows.join('');
        }

        function updateUavGrid(uavMetrics, uavCrds) {
            const metricsMap = uavMetrics ?? {};
            const crdByNode = {};
            (uavCrds ?? []).forEach(item => {
                const nodeName = item?.spec?.node_name;
                if (nodeName) {
                    crdByNode[nodeName] = item;
                }
            });

            const nodeKeys = Array.from(new Set([
                ...Object.keys(metricsMap),
                ...Object.keys(crdByNode)
            ]));

            if (!nodeKeys.length) {
                elements.uavGrid.innerHTML = '<div class="empty-state">暂无 UAV 上报数据</div>';
                return;
            }

            nodeKeys.sort();
            const cards = nodeKeys.map(nodeName => {
                const metric = metricsMap[nodeName] ?? {};
                const crd = crdByNode[nodeName];
                const status = (metric.status || crd?.status?.collection_status || 'unknown').toLowerCase();
                const badgeVariant = status === 'active' ? 'success' : status === 'warning' ? 'warning' : 'default';
                const uavId = metric.uav_id || crd?.spec?.uav_id || '未知 UAV';
                const heartbeat = metric.last_heartbeat || crd?.status?.last_update;
                const flightMode = metric.state?.flight?.mode || crd?.spec?.flight?.mode || '-';
                const batteryPercent = metric.state?.battery?.remaining_percent ?? crd?.spec?.battery?.remaining_percent;
                const gps = metric.state?.gps || crd?.spec?.gps;

                return `
                    <article class="uav-card">
                        <div class="uav-header">
                            <div>
                                <h3>${uavId}</h3>
                                <span class="sub">节点：${nodeName}</span>
                            </div>
                            <span class="badge" data-variant="${badgeVariant}">
                                <span class="status-dot" data-status="${status === 'active' ? 'healthy' : 'warning'}"></span>
                                ${status.toUpperCase()}
                            </span>
                        </div>
                        <div class="details">
                            <span><strong>飞行模式</strong>${flightMode}</span>
                            <span><strong>电量</strong>${batteryPercent !== undefined ? `${batteryPercent.toFixed ? batteryPercent.toFixed(1) : batteryPercent}%` : '-'}</span>
                            <span><strong>心跳</strong>${formatDateTime(heartbeat)}</span>
                            <span><strong>心跳间隔</strong>${metric.heartbeat_interval_seconds ? `${metric.heartbeat_interval_seconds}s` : '-'}</span>
                            <span><strong>经纬度</strong>${gps ? `${gps.latitude?.toFixed?.(4) ?? '-'} , ${gps.longitude?.toFixed?.(4) ?? '-'}` : '-'}</span>
                            <span><strong>高度</strong>${gps?.altitude !== undefined ? `${gps.altitude} m` : '-'}</span>
                        </div>
                        <span class="sub">CRD 更新时间：${formatDateTime(crd?.status?.last_update)}</span>
                    </article>
                `;
            });

            elements.uavGrid.innerHTML = cards.join('');
        }

        async function loadDashboard(auto = false) {
            setLoading(!auto);
            try {
                const [clusterRes, nodesRes, podsRes, uavMetricsRes, uavCrdRes] = await Promise.all([
                    fetchJSON(endpoints.cluster).catch(() => null),
                    fetchJSON(endpoints.nodes),
                    fetchJSON(endpoints.pods),
                    fetchJSON(endpoints.uavMetrics),
                    fetchJSON(endpoints.uavCrd)
                ]);

                const cluster = clusterRes?.data ?? null;
                const nodes = nodesRes?.data ?? {};
                const pods = podsRes?.data ?? {};
                const uavMetrics = uavMetricsRes?.data ?? {};
                const uavCrds = uavCrdRes?.data ?? [];

                updateSummary(cluster, uavMetrics, uavCrds.length);
                updateNodesTable(nodes);
                updatePodsTable(pods);
                updateUavGrid(uavMetrics, uavCrds);

                const now = new Date();
                elements.lastUpdated.textContent = `最后更新：${formatDateTime(now)}`;
                hideStatus();
            } catch (error) {
                console.error(error);
                showStatus(error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        elements.refreshButton.addEventListener('click', () => loadDashboard(false));

        loadDashboard(false);
        setInterval(() => {
            loadDashboard(true);
        }, REFRESH_INTERVAL);
    </script>
</body>
</html>
